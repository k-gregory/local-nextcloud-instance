- name: Bootstrap Server (Install Python and Setup Sudo)
  hosts: all
  gather_facts: no  # Required because Python is missing
  become: yes

  vars:
    new_user: ansible_worker
  
  tasks:
    - name: Install Python 3 using raw SSH commands
      raw: |
        command -v python3 >/dev/null 2>&1 || \
        (apt-get update && apt-get install -y python3)
      register: python_install
      changed_when: "'installed' in python_install.stdout or 'unpacking' in python_install.stdout"

    - name: Gather facts now that Python is installed
      setup: # This manually triggers the "Gathering Facts" step

    - name: Create the ansible user
      user:
        name: "{{ new_user }}"
        shell: /bin/bash
        groups: sudo
        append: yes      

    - name: Set up authorized keys for the new user
      authorized_key:
        user: "{{ new_user }}"
        state: present
        key: "{{ lookup('file', '~/.ssh/id_ed25519.pub') }}"        

    - name: Allow the new user passwordless sudo
      copy:
        content: "{{ new_user }} ALL=(ALL) NOPASSWD:ALL"
        dest: "/etc/sudoers.d/{{ new_user }}"
        mode: '0440'
        validate: '/usr/sbin/visudo -cf %s'        